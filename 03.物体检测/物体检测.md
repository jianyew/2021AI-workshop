Zx



## 提前准备

* 提高 Sagemaker P3 实例的limit：https://fleet-management-console.amazon.com/public_aws_limit_requests/new
* 选择 Amazon Sagemaker - Training ml.p3.2xlarge instance，数量为6
* 事先装好putty
* 事先准备好装好公司安全agent的ami 供大家小而美实验用到 / 或者申请 enent engine的临时账户

* * *

## 目录

* 预习资料 -all
* 实验手册
    * ground truth 图像分类 guide - yuanyuan
    * notebook 实例guide - wqx 
    * 超参数调优作业 guide - beibei
    * 知识问答+数据流程图 -all
* 记分系统 - binc
* 比赛实时dashboard - binc

## 预习资料整理

> To BD: 也可以在highspot上找下sagemaker的片子，要熟悉基本200的内容，动手的话多看视频和文档。


基础：

* AI初级介绍[PPT]：https://aws.highspot.com/items/5d3f40b6429d7b0dd72bb2bf?lfrm=srp.1
* SageMaker 官方文档 :  https://docs.aws.amazon.com/zh_cn/sagemaker/latest/dg/whatis.html 
* AWS 机器学习平台 Amazon SageMaker 详解[视频] : http://aws.amazon.bokecc.com/news/show-2442.html

Groudtruth 做数据标记：

* 11使用Amazon SageMaker打造准确的数据标记集[视频] : http://aws.amazon.bokecc.com/news/show-2461.html
* Ground Truth 官方文档： [重点看前面两个小节] https://docs.aws.amazon.com/zh_cn/sagemaker/latest/dg/sms.html 

使用sagemaker notebook：

* 1-使用Amazon SageMaker托管的Jupyter Notebook实例[视频] : http://aws.amazon.bokecc.com/news/show-2464.html 
* 4使用Amazon SageMaker 训练模型[视频] : http://aws.amazon.bokecc.com/news/show-2468.html
* 开始使用 Amazon SageMaker 笔记本实例官方文档 :  https://docs.aws.amazon.com/zh_cn/sagemaker/latest/dg/gs-console.html 

超参优化：

* 超参数概念介绍：https://www.jianshu.com/p/6602c76cc801
* 6使用Amazon SageMaker超参自动调优[视频] :：http://aws.amazon.bokecc.com/news/show-2469.html
* 超参数自动优化官方文档：https://docs.aws.amazon.com/zh_cn/sagemaker/latest/dg/automatic-model-tuning.html

选看：

* 机器学习入门：https://aws.highspot.com/items/5d3b9510429d7b3b1d8eb6dd?lfrm=srp.4#1




## 实验手册的设计

### ground truth 图像分类 guide (yy )

> sagemaker / s3 / cognito

tips：注意私有团队的邮箱是否需要验证

### notebook 实例 （代码-图像分类-ready）(wqx )

> 待确认：bd账号是否有sagemaker limit，或者用event engine提前生成账号

> BD 对 jupyter nb的基本执行基础认识

* 启动sagemaker实例
* jupyter notebook ：`使用Amazon SageMaker训练汽车型号图像识别的模型`
    * 训练完成发送通知到邮件，结合SNS 
    * 训练过程监控数据查看，结合cloudwatch 
    * 部署模型，生成endpoint，体验一键部署
* 部署之后做autoscaling

### 超参数调优作业 guide (Beibei  )

### 其余项目

* 知识问答题目设计
    * Sagemaker的优势/功能
    * AI service 各个功能
    * 结合场景选择对应的服务
    * 基本GPU实例类型
* 数据流程图 
    * 加分点 ：模型管理可以用ddb / lambda自动触发训练流程 / 数据处理可以用的其他服务
* 加分项
    * 自己找到超参数优化的目标指标
    * 哪些超参数以及范围
    * 流程图
    * 部署终端节点的autoscaling
    * 




## 分数统计和展示(binc)

实时Dashboard： [dash20.awsabc.cn](http://dash20.awsabc.cn/)
SA打分板： [score20.awsabc.cn](http://score20.awsabc.cn/)
* * *

## 详细步骤

## 实验1：使用 ground truth 给图像打标签

### 创建团队

1. 在sagemaker控制台点击“标签工作人员”进入创建团队界面。

[Image: image.png]
1. 点击“私有” 进入私有团队界面。

    1. 在私有团队部分 点击“创建私有团队”

[Image: image.png]b. 输入“团队名称” ，其他选项保持默认，点击“创建私有团队”

1. 在工作人员部分 点击“邀请工作人员“

[Image: image.png]

[Image: image.png]
    1. 输入新工作人员的邮件地址，点击“邀请新工作人员”

[Image: image.png]b. 系统将向新工作人员邮箱发送邀请邮件，请新工作人员打开链接，更改密码，进入工作界面。
[Image: image.png]
1. [Image: image.png]
2. 在私有团队界面，点击新创建的团队，进入团队详情界面后，点击“向团队添加工作人员”

[Image: image.png]
    1. 点击要添加的组员到团队中。

[Image: image.png]



### 创建任务

1. 下载准备好的图像文件到本地

https://eastcode.s3.amazonaws.com/car_data.zip

1. 拆分文件夹，将jpg文件上传图像文件到所在区域的s3 bucket

上传文件到组长账号的存储桶内的指定路径中。
[Image: image.png]
1. 为数据集创建一个清单文件并将其存储在 S3 存储桶中。
    1. 使用文本编辑器，创建一个新的文本文件。
    2. 为数据集中的每个图像文件添加与以下内容类似的一行：
2. `{"source-ref": "s3://bucket/path/imageFile.png"}`
3. 将该文件保存在包含源文件的 S3 存储桶中。
4. 使用拥有admin权限的账户进行标记任务的创建，检查小组长的user是否为admin权限
    1. [Image: image.png]
5. 创建标记作业
    1. 在左侧导航栏中，选择 **Labeling jobs (贴标作业)**。 
    2. 选择 **Create labeling job (创建标记作业)** 以开始作业创建过程。 
    3. 在 **Job overview (作业概览)** 部分中，提供以下信息： 
       
    4. **Job name (作业名称)** – 为标记作业提供一个描述此作业的名称。此名称将显示在作业列表中。该名称在您的账户和 AWS 区域中都必须是唯一的。 
        1. **输入数据设置** – 选择**“手动数据设置”**。 
        2. **Input dataset location (输入数据集位置)** – 输入您在步骤 1 中创建的清单文件的 S3 位置。 
        3.  **输出数据集位置** – 输出数据将写入到的位置。 
        4. **IAM 角色** – 选择“创建新角色”，输入输入数据的s3桶的名称，创建只允许访问特定s3桶的角色。

[Image: image.png][Image: image.png]
[Image: image.png][Image: image.png]
e. 在**任务类型**部分，对于 **Dataset type (数据集类型)** 字段，选择 **图像分类( 单标签）** 作为任务类型。 
f.  选择 **Next (下一步)** 继续配置您的标记作业。 
[Image: image.png]g. 团队类型选择“**私有**”。
h. 在“**团队名称**”输入上一步创建的团队名称。


[Image: image.png]

i. 在上方文本框输入对此次标记的概述，例如“please select the brand of this car”
j. 在右侧输入车类型的种类，如“audi”“BMW”等，点击添加标签可以添加新标签。可以点击预览进行标记界面的预览。
k. 点击“创建”完成任务创建。
[Image: image.png]l: 等待几分钟后，工作人员可以登陆到标签工作界面进行打标签工作。

点击相应任务后，点击start working
[Image: image.png]
m: 来到标记界面，点击右侧相应的图像label 选择相应的种类，点击右下角的submit。


## 实验2：使用 Notebook 实例跑图像分类

> 2020 BD Tech day- Sagemaker instance 部分

### 0-环境准备

1. 创建S3桶
2. 创建IAM role，赋予sagemaker和s3的权限

### 1- 启动Sagemaker笔记本实例

> 登录到控制台([https://console.aws.amazon.com/](https://console.amazonaws.cn/)) ，切换区域到“ap-northeast-1”，在SageMaker服务中创建一个笔记本实例，按默认”创建 IAM 角色“,笔记本实例类型根据需要可选”ml.t3.medium“;
> 等待该笔记本实例创建完成，状态由”Pending“变为”InService“，点击后面的链接”打开 Jupyter“即可进入Jupyter

1. 登录到控制台([https://console.aws.amazon.com/](https://console.amazonaws.cn/)) ，切换区域到“ap-northeast-1”，选择SageMaker服务中的笔记本实例

[Image: image.png]
1. 选择创建笔记本实例

[Image: image.png]
* ` **笔记本实例名称** `：自定义名称
* ` **笔记本实例类型** `：根据需要可选”ml.t3.medium“;
* [Image: image.png]
* **` 权限和加密-IAM角色 `**：按默认”创建 IAM 角色“,
* [Image: image.png]
* 其余选项可以保持默认
* 最后点击 **`创建笔记本实例 `**
* [Image: image.png]

1. 打开Sagemaker笔记本实例
    1. 需要该笔记本实例状态变成绿色` InService` 的可用状态
    2. 打开Sagemaker笔记本实例之后如下图所示：

[Image: image.png][Image: image.png]
1. 上传本次实验的sample code到Sagemaker笔记本实例
    1. 下载链接🔗[CarsClassifier-SageMakerPythonSDK.ipynb](https://s3-ap-northeast-1.amazonaws.com/www.qi-xiang.wang/bd-tech-day/CarsClassifier-SageMakerPythonSDK.ipynb)
    2. 先下载上述文件到本地，然后点击Sagemaker笔记本实例的` upload ，`选择保存文件的位置以及文件完成上传

[Image: image.png][Image: image.png]
1. 打开本次实验的jupyter notebook

[Image: image.png]
1. 在本次实验的jupyter notebook中依次执行每一个代码块

### 2-使用控制台配置模型自动扩展

1. 转到Sagemaker控制台查看通过notebook部署的终端节点

[Image: image.png]
1. 点击已经部署好的终端节点，查看 **终端节点运行时设置 **

[Image: image.png]
1. 点击 配置 AutoScaling，此时将显示 **Configure variant automatic scaling** (配置变体自动扩展) 页面。

    1. **Minimum capacity** (最小容量)：扩展策略维护的最小实例数。（至少需要 1 个实例）本次实验保持默认。
    2. **Maximum capacity** (最大容量)：扩展策略维护的最大实例数。本次实验设置为2。
    3.  **target value (目标值)**：模型每分钟每个实例的平均调用次数。（一般建议客户实际压测之后再确定）本次实验设置为50。
    4. **Scale-in cool down (seconds)** (缩减冷却 (秒)) 和 **Scale-out cool down (seconds)** (扩展冷却 (秒))：每个实例冷却时间的秒数。本次实验保持默认。
    5. **Disable scale in** (禁用缩减) ：禁用扩展活动删除实例，本次实验保持默认即不做设置。
    6. 选择 **Save (保存)**。

[Image: image.png]
1. 确认自动扩展配置生效

[Image: image.png]


## 实验3：超参数优化任务

> 实验前提：在上一步的 Notebook 中已经完成了 Step3（ 将图像数据分为训练集和测试集上传至S3）

### 1.数据集已经上传至S3

* 确认实验所需数据集已经按照训练和测试集进行划分，并上传至S3
* [Image: image.png]



### 2.定义超参优化作业

* 在Sagemaker 控制台中创建超参优化作业。策略选择 Random
* [Image: image.png]



### 3.配置算法和参数

* 添加训练作业定义
* 自定义添加作业名称
* 选择在上一个实验中创建的 IAM Role
* [Image: image.png]
* 选择内置算法中的图像分类算法，文件模式选择File，不启用 Sagemaker 指标时间序列
* [Image: image.png]
* 根据预习资料选择正确的目标指标
* [Image: image.png]
* 调整超级参数设置
    * 把 epochs 设为100，mini_batch_size 设为30
    * 根据预习资料找到需要进行调整的超参数，剩下的超参数设为默认值
    * 根据预习资料对需要进行调整的超参数设定一个调整范围（提示：范围不可过大）
    * [Image: image.png]
    * [Image: image.png]
    * 根据实验2自行填写两个必填参数：num_classes 和 num_training_samples
    * [Image: image.png]
    * 选择下一步



### 4.定义数据输入和输出

* 添加训练数据集通道，输入模式为File，内容类型填写“application/x-recordio”，其他保持默认
* 输入训练数据集在S3中的URI
* [Image: image.png]
* 点击添加通道，通道名称填写“validation”，输入模式为File，内容类型填写“application/x-recordio”，其他默认，添加验证数据集在S3中的URI
* [Image: image.png]
* 检查点选择保持默认
* 配置输出路径，添加S3输入路径，比如：s3://your_bucket_name/output/
* [Image: image.png]
* 点击下一步



### 5.配置训练计算资源

* 添加实例类型为 ml.p3.2xlarge，实例数量选择1，实例附加卷大小选择300GB
* [Image: image.png]
* 不启用托管 Spot 训练
* 停止条件选择1天
* 点击下一步



### 6.配置超参优化作业任务数

* 进行资源配置，最大并发训练任务数选择2，训练任务最大次数选择4（麻烦review的时候吧下面这张图改成训练次数为4的图片）
* 注意：如果遇到 limit 限制，请按照提示自行修改最大并发训练任务数
* [Image: image.png]
* 点击下一步



### 7.开启超参数优化训练任务

* 审核任务，并点击创建参数优化作业。
* [Image: image.png]



### 8.查看超参数优化训练任务结果

* 在控制台查看超参数优化训练作业结果，找到最优的一次训练作业以及对应的超参数设置
* [Image: image.png]
* [Image: image.png]
* [Image: image.png]


